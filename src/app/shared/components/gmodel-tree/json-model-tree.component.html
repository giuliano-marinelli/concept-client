<div class="tree-root text-nowrap">
  <ng-container [ngTemplateOutlet]="treeNode" [ngTemplateOutletContext]="{ node: model, expanded: true, path: '' }">
  </ng-container>
</div>

<ng-template #treeNode let-node="node" let-expanded="expanded" let-path="path">
  <ng-container *ngVar="{ expanded: expanded } as settings">
    <div class="node-placeholder-container" (dragleave)="onNodeDragLeave($event)">
      <li #placeholder class="node-placeholder" *ngIf="!jsonModel.checkNodeCanHaveFields(jsonModel.getNodeParent(path))"
        [attr.data-path]="path" (dragover)="onNodeDragOver($event, path, node)" (drop)="onNodeDrop($event, path, node)">
      </li>
      <ng-container [ngTemplateOutlet]="treeButton"
        [ngTemplateOutletContext]="{ node: node, settings: settings, path: path }">
      </ng-container>
    </div>
    <ul class="node-children" [class.expanded]="settings.expanded">
      <ng-container *ngIf="config?.nodes?.[node.type]?.fields">
        <li #nodeContainer class="node-container"
          *ngFor="let field of config?.nodes?.[node.type]?.fields; let i = index" [attr.data-path]="path + '/' + field"
          [class.mt-1]="i == 0"
          [class.pb-1]="!node[field] || (!node[field].children?.length && !jsonModel.checkNodeCanHaveFields(node[field]))">
          <label class="ps-4 text-muted">{{ field }}:</label><br>
          <ng-container *ngIf="node[field]" [ngTemplateOutlet]="treeNode"
            [ngTemplateOutletContext]="{ node: node[field], expanded: expanded, path: path + '/' + field }">
          </ng-container>
          <ng-container *ngIf="!node[field]" [ngTemplateOutlet]="treeButton"
            [ngTemplateOutletContext]="{ path: path + '/' + field }">
          </ng-container>
        </li>
      </ng-container>
      <ng-container *ngIf="!config?.nodes?.[node.type]?.fields">
        <li #nodeContainer class="pt-1 node-container" *ngFor="let child of node.children; let i = index"
          [attr.data-path]="path + '/' + i" [class.mt-1]="i == 0"
          [class.pb-1]="!child.children?.length && !jsonModel.checkNodeCanHaveFields(child)">
          <ng-container [ngTemplateOutlet]="treeNode"
            [ngTemplateOutletContext]="{ node: child, expanded: expanded, path: path + '/' + i }">
          </ng-container>
        </li>
      </ng-container>
    </ul>
  </ng-container>
</ng-template>

<ng-template #treeButton let-node="node" let-settings="settings" let-path="path">
  <ng-container>
    <button class="btn btn-sm text-muted no-outline" (click)="settings.expanded = !settings.expanded">
      <fa-icon
        [icon]="jsonModel.checkNodeCanHaveChildren(node) || jsonModel.checkNodeCanHaveFields(node) ? (settings.expanded ? 'caret-down' : 'caret-right') : 'minus'">
      </fa-icon>
    </button>
    <button
      class="btn btn-sm btn-{{ node?._selected ? '' : 'outline-' }}secondary text-{{ node ? 'body' : 'muted' }} text-start"
      [attr.draggable]="node && path !== ''" (dragstart)="onNodeDragStart($event, path)"
      (dragend)="onNodeDragEnd($event)" (dragover)="onNodeDragOver($event, path, node)"
      (dragenter)="onNodeDragEnter($event, path, node)" (dragleave)="onNodeDragLeave($event)"
      (drop)="onNodeDrop($event, path, node, false)" (click)="onNodeClick(path, node)">
      <ng-container *ngIf="node">
        <fa-icon [icon]="config?.nodes?.[node.type]?.icon || config?.defaultIcon || 'circle'"></fa-icon>
        {{ node.type }}<br>
        <span class="text-muted small">
          {{ config?.nodes?.[node.type]?.descriptor ? node[config?.nodes?.[node.type]?.descriptor!] : '' }}
        </span>
      </ng-container>
      <ng-container *ngIf="!node">
        empty
      </ng-container>
    </button>
    <button class="btn btn-sm p-1 ms-1 text-body no-outline" *ngIf="jsonModel.checkNodeCanHaveChildren(node)">
      <fa-icon [icon]="'plus'"></fa-icon>
    </button>
  </ng-container>
</ng-template>