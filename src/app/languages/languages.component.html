<div class="container">
  <div class="mt-3 pb-3 border-bottom">
    <h2><fa-icon [icon]="'book'"></fa-icon> Languages <a class="btn p-0 text-muted border-0"
        (click)="search_input.onSearch(false)" [class.disabled]="languagesLoading">
        <fa-icon [icon]="'rotate-right'" size="lg" [animation]="languagesLoading ? 'spin-pulse' : undefined"></fa-icon>
      </a>
    </h2>
  </div>
  <search #search_input searchClass="mt-3" [attributes]="[
    { name: 'name', title: 'Name', type: 'string', simple: true },
    { name: 'tag', title: 'Tag', type: 'string', simple: true },
    { name: 'version', title: 'Version', type: 'string', simple: true },
    { name: 'createdAt', title: 'Created at', type: 'Date' },
    { name: 'owner.username', title: 'Owner', type: 'string', simple: true },
    { name: 'metaElements.tag', title: 'Element', type: 'string', simple: true }
  ]" [(search)]="languagesSearch" (searchChange)="getLanguages()"></search>
  <div #message_container></div>
  <div class="text-center mt-3" *ngIf="!languagesLoading && languages.length <= 0">
    <fa-icon class="fa-fade" [icon]="'magnifying-glass'" size="3x"></fa-icon>
    <p class="mt-2">No languages found</p>
  </div>
  <ngx-masonry #masonry [options]="{ percentPosition: true, horizontalOrder: true }" [ordered]="true" class="row mt-3"
    [class.loading]="languagesLoading" *ngIf="languages.length > 0">
    <div ngxMasonryItem class="col-12 col-md-6 col-lg-4 mb-4 masonry-item" *ngFor="let language of languages">
      <ng-container [ngTemplateOutlet]="languageCard"
        [ngTemplateOutletContext]="{ language: language, masonry: masonry }"></ng-container>
    </div>
  </ngx-masonry>
  <ngb-pagination *ngIf="languagesCount > 0" class="d-flex justify-content-center mt-3" [(page)]="languagesPage"
    [pageSize]="languagesPageSize" [collectionSize]="languagesCount" (pageChange)="getLanguages()" size="sm"
    [maxSize]="3" [rotate]="true" [ellipses]="true" [boundaryLinks]="true">
  </ngb-pagination>
</div>

<ng-template #languageCard let-language="language" let-masonry="masonry">
  <div class="card bg-dark-subtle" (resized)="masonry.layout()">
    <div *ngIf="submitLoading.includes(language.id)"
      class="overlay d-flex align-items-center text-center text-body rounded">
      <fa-icon class="flex-fill" [icon]="'spinner'" [animation]="'spin-pulse'" size="2x"></fa-icon>
    </div>
    <div class="card-body">
      <div class="card-text">
        <div class="d-flex flex-row pb-1">
          <div class="flex-shrink-0">
            <img class="me-3 img-thumbnail rounded-circle logo-img" [src]="language.logo"
              onerror="this.src='assets/images/default-language.png'" />
          </div>
          <div class="flex-fill d-flex flex-column text-break">
            <span class="small" *ngIf="language.name">{{ language.name }}</span>
            <span [ngClass]="language.name ? 'text-muted small' : ''">{{ language.tag }}&#64;{{ language.version
              }}</span>
          </div>
          <div ngbDropdown display="dynamic" placement="bottom-end" autoClose="true">
            <a class="btn p-0 text-body">
              <fa-icon class="no-dropdown-arrow" [icon]="'ellipsis-vertical'" ngbDropdownToggle></fa-icon>
            </a>
            <div *ngIf="language.owner?.id == auth.user?.id || auth.user?.role == 'ADMIN'"
              class="dropdown-menu shadow-sm" ngbDropdownMenu>
              <a ngbDropdownItem class="small pe-pointer"
                routerLink="/language/{{ language.tag }}@{{ language.version }}">
                <fa-icon [icon]="'eye'"></fa-icon> Inspect
              </a>
              <a ngbDropdownItem class="small pe-pointer" (confirm)="deleteLanguage(language)"
                [confirmTemplate]="delete_message" confirmActionButton="Delete">
                <fa-icon [icon]="'trash'"></fa-icon> Delete
              </a>
              <ng-template #delete_message>
                <p class="mb-0">
                  Are you sure you want to delete the language:
                </p>
                <ng-container [ngTemplateOutlet]="languageMini"
                  [ngTemplateOutletContext]="{ language: language }"></ng-container>
              </ng-template>
            </div>
          </div>
        </div>
        <div *ngIf="language.description">
          <div class="mt-1 small" *ngVar="{ descriptionCollapsed: true } as descriptionSettings">
            <a [ngClass]="language.description ? 'pe-pointer dropdown-toggle text-body' : ''"
              (click)="language.description ? descriptionCollapse.toggle() : null"
              [attr.aria-expanded]="!descriptionSettings.descriptionCollapsed">
              <b>Description</b>
              <span *ngIf="!language.description" class="text-muted">&nbsp;empty</span>
            </a>
            <div #descriptionCollapse="ngbCollapse" [(ngbCollapse)]="descriptionSettings.descriptionCollapsed">
              <div class="card">
                <div class="card-body p-2">
                  {{ language.description }}
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="mt-1 pt-1 small border-top">
          <b>Created at:</b> {{ language.createdAt | amLocal | amDateFormat:'LLL' }}
        </div>
      </div>
    </div>
  </div>
</ng-template>

<ng-template #languageMini let-language="language">
  <div class="card m-auto mt-2" style="max-width: 220px;">
    <div class="card-body p-2">
      <div class="d-flex flex-row">
        <div class="flex-shrink-0">
          <img class="me-3 img-thumbnail rounded-circle logo-img" [src]="language.logo"
            onerror="this.src='assets/images/default-language.png'" />
        </div>
        <div class="flex-fill d-flex flex-column text-break">
          <span class="small" *ngIf="language.name">{{ language.name }}</span>
          <span [ngClass]="language.name ? 'text-muted small' : ''">{{ language.tag }}&#64;{{ language.version }}</span>
        </div>
      </div>
    </div>
  </div>
</ng-template>
